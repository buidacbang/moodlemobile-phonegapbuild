webpackJsonp([65],{1474:function(n,i,t){"use strict";function e(n){return o._27(0,[(n()(),o._3(0,0,null,null,13,"ion-item",[["class","item-title item item-block"],["text-wrap",""]],null,null,null,S.b,S.a)),o._2(1,1097728,null,3,V.a,[A.a,N.a,o.l,o.C,[2,W.a]],null,null),o._23(335544320,2,{contentLabel:0}),o._23(603979776,3,{_buttons:1}),o._23(603979776,4,{_icons:1}),o._2(5,16384,null,0,B.a,[],null,null),(n()(),o._25(-1,2,["\n                "])),(n()(),o._3(7,0,null,3,5,"ion-input",[["name","title"],["type","text"]],[[2,"ng-untouched",null],[2,"ng-touched",null],[2,"ng-pristine",null],[2,"ng-dirty",null],[2,"ng-valid",null],[2,"ng-invalid",null],[2,"ng-pending",null]],null,null,R.b,R.a)),o._2(8,671744,null,0,d.f,[[3,d.b],[8,null],[8,null],[8,null]],{name:[0,"name"]},null),o._21(2048,null,d.m,null,[d.f]),o._2(10,16384,null,0,d.n,[d.m],null,null),o._2(11,5423104,null,0,j.a,[N.a,H.a,A.a,J.a,o.l,o.C,[2,Y.a],[2,V.a],[2,d.m],$.a],{type:[0,"type"],placeholder:[1,"placeholder"]},null),o._18(131072,G.a,[K.a,o.g]),(n()(),o._25(-1,2,["\n            "]))],function(n,i){n(i,8,0,"title");n(i,11,0,"text",o._26(i,11,1,o._15(i,12).transform("addon.mod_wiki.newpagetitle")))},function(n,i){n(i,7,0,o._15(i,10).ngClassUntouched,o._15(i,10).ngClassTouched,o._15(i,10).ngClassPristine,o._15(i,10).ngClassDirty,o._15(i,10).ngClassValid,o._15(i,10).ngClassInvalid,o._15(i,10).ngClassPending)})}function l(n){return o._27(0,[(n()(),o._3(0,0,null,null,3,"ion-badge",[["color","danger"],["item-end",""]],null,null,null,null,null)),o._2(1,16384,null,0,Z.a,[N.a,o.l,o.C],{color:[0,"color"]},null),(n()(),o._25(2,null,["",""])),o._18(131072,G.a,[K.a,o.g])],function(n,i){n(i,1,0,"danger")},function(n,i){n(i,2,0,o._26(i,2,0,o._15(i,3).transform("addon.mod_wiki.wrongversionlock")))})}function a(n){return o._27(0,[(n()(),o._3(0,0,null,null,22,"ion-header",[],null,null,null,null,null)),o._2(1,16384,null,0,q.a,[N.a,o.l,o.C,[2,z.a]],null,null),(n()(),o._25(-1,null,["\n    "])),(n()(),o._3(3,0,null,null,18,"ion-navbar",[["class","toolbar"]],[[8,"hidden",0],[2,"statusbar-padding",null]],null,null,Q.b,Q.a)),o._2(4,49152,null,0,X.a,[J.a,[2,z.a],[2,nn.a],N.a,o.l,o.C],null,null),(n()(),o._25(-1,3,["\n        "])),(n()(),o._3(6,0,null,3,3,"ion-title",[],null,null,null,tn.b,tn.a)),o._2(7,49152,null,0,en.a,[N.a,o.l,o.C,[2,ln.a],[2,X.a]],null,null),(n()(),o._3(8,0,null,0,1,"core-format-text",[],null,null,null,null,null)),o._2(9,540672,null,0,an.a,[o.l,g.a,f.a,_.a,K.a,H.a,on.a,un.a,rn.a,sn.a,dn.a,cn.a,[2,nn.a],[2,Y.a]],{text:[0,"text"]},null),(n()(),o._25(-1,3,["\n\n        "])),(n()(),o._3(11,0,null,2,9,"ion-buttons",[["end",""]],null,null,null,null,null)),o._2(12,16384,null,1,gn.a,[N.a,o.l,o.C,[2,ln.a],[2,X.a]],null,null),o._23(603979776,1,{_buttons:1}),(n()(),o._25(-1,null,["\n            "])),(n()(),o._3(15,0,null,null,4,"button",[["clear",""],["ion-button",""]],[[1,"aria-label",0]],[[null,"click"]],function(n,i,t){var e=!0;if("click"===i){e=!1!==n.component.save()&&e}return e},hn.b,hn.a)),o._2(16,1097728,[[1,4]],0,fn.a,[[8,""],N.a,o.l,o.C],{clear:[0,"clear"]},null),o._18(131072,G.a,[K.a,o.g]),(n()(),o._25(18,0,["\n                ","\n            "])),o._18(131072,G.a,[K.a,o.g]),(n()(),o._25(-1,null,["\n        "])),(n()(),o._25(-1,3,["\n    "])),(n()(),o._25(-1,null,["\n"])),(n()(),o._25(-1,null,["\n"])),(n()(),o._3(24,0,null,null,32,"ion-content",[],[[2,"statusbar-padding",null],[2,"has-refresher",null]],null,null,_n.b,_n.a)),o._2(25,4374528,null,0,Y.a,[N.a,H.a,$.a,o.l,o.C,J.a,In.a,o.x,[2,z.a],[2,nn.a]],null,null),(n()(),o._25(-1,1,["\n    "])),(n()(),o._3(27,0,null,1,28,"core-loading",[],null,null,null,pn.b,pn.a)),o._2(28,638976,null,0,kn.a,[K.a,o.l],{hideUntil:[0,"hideUntil"]},null),(n()(),o._25(-1,0,["\n        "])),(n()(),o._3(30,0,null,0,24,"form",[["ion-list",""],["novalidate",""]],[[2,"ng-untouched",null],[2,"ng-touched",null],[2,"ng-pristine",null],[2,"ng-dirty",null],[2,"ng-valid",null],[2,"ng-invalid",null],[2,"ng-pending",null]],[[null,"submit"],[null,"reset"]],function(n,i,t){var e=!0;if("submit"===i){e=!1!==o._15(n,32).onSubmit(t)&&e}if("reset"===i){e=!1!==o._15(n,32).onReset()&&e}return e},null,null)),o._2(31,16384,null,0,d.w,[],null,null),o._2(32,540672,null,0,d.h,[[8,null],[8,null]],{form:[0,"form"]},null),o._21(2048,null,d.b,null,[d.h]),o._2(34,16384,null,0,d.o,[d.b],null,null),(n()(),o._25(-1,null,["\n            "])),(n()(),o.Y(16777216,null,null,1,null,e)),o._2(37,16384,null,0,wn.k,[o.M,o.J],{ngIf:[0,"ngIf"]},null),(n()(),o._25(-1,null,["\n\n            "])),(n()(),o._3(39,0,null,null,10,"ion-item",[["class","item item-block"]],null,null,null,S.b,S.a)),o._2(40,1097728,null,3,V.a,[A.a,N.a,o.l,o.C,[2,W.a]],null,null),o._23(335544320,5,{contentLabel:0}),o._23(603979776,6,{_buttons:1}),o._23(603979776,7,{_icons:1}),o._2(44,16384,null,0,B.a,[],null,null),(n()(),o._25(-1,2,["\n                "])),(n()(),o._3(46,0,null,3,2,"core-rich-text-editor",[["item-content",""],["name","wiki_page_content"]],null,null,null,mn.b,mn.a)),o._2(47,1228800,null,0,vn.a,[f.a,bn.a,un.a,g.a,sn.a,[2,Y.a],o.l],{placeholder:[0,"placeholder"],control:[1,"control"],name:[2,"name"],component:[3,"component"],componentId:[4,"componentId"]},null),o._18(131072,G.a,[K.a,o.g]),(n()(),o._25(-1,2,["\n            "])),(n()(),o._25(-1,null,["\n\n            "])),(n()(),o.Y(16777216,null,null,1,null,l)),o._2(52,16384,null,0,wn.k,[o.M,o.J],{ngIf:[0,"ngIf"]},null),(n()(),o._25(-1,null,[" "])),(n()(),o._25(-1,null,["\n        "])),(n()(),o._25(-1,0,["\n    "])),(n()(),o._25(-1,1,["\n"])),(n()(),o._25(-1,null,["\n"]))],function(n,i){var t=i.component;n(i,9,0,t.title);n(i,16,0,"");n(i,28,0,t.loaded);n(i,32,0,t.pageForm);n(i,37,0,t.canEditTitle);n(i,47,0,o._26(i,47,0,o._15(i,48).transform("core.content")),t.contentControl,"wiki_page_content",t.component,t.componentId);n(i,52,0,t.wrongVersionLock)},function(n,i){n(i,3,0,o._15(i,4)._hidden,o._15(i,4)._sbPadding);n(i,15,0,o._26(i,15,0,o._15(i,17).transform("core.save")));n(i,18,0,o._26(i,18,0,o._15(i,19).transform("core.save")));n(i,24,0,o._15(i,25).statusbarPadding,o._15(i,25)._hasRefresher);n(i,30,0,o._15(i,34).ngClassUntouched,o._15(i,34).ngClassTouched,o._15(i,34).ngClassPristine,o._15(i,34).ngClassDirty,o._15(i,34).ngClassValid,o._15(i,34).ngClassInvalid,o._15(i,34).ngClassPending)})}Object.defineProperty(i,"__esModule",{value:!0});var o=t(1),u=(t(0),t(10),t(8)),r=t(33),s=t(31),d=t(18),c=t(22),g=t(2),h=t(77),f=t(7),_=t(11),I=t(15),p=t(42),k=t(189),w=t(233),m=t(264),v=function(){function n(n,i,t,e,l,a,o,u,r,s,d,c,g,h){this.navCtrl=t,this.sitesProvider=e,this.syncProvider=l,this.domUtils=a,this.translate=o,this.courseProvider=u,this.eventsProvider=r,this.wikiProvider=s,this.wikiOffline=d,this.wikiSync=c,this.textUtils=g,this.courseHelper=h,this.component=k.a.COMPONENT,this.forceLeave=!1,this.isDestroyed=!1,this.module=n.get("module")||{},this.courseId=n.get("courseId"),this.subwikiId=n.get("subwikiId"),this.wikiId=n.get("wikiId"),this.pageId=n.get("pageId"),this.section=n.get("section"),this.groupId=n.get("groupId"),this.userId=n.get("userId");var f=n.get("pageTitle");f=f?f.replace(/\+/g," "):"",this.initialSubwikiId=this.subwikiId,this.componentId=this.module.id,this.canEditTitle=!f,this.title=f?this.translate.instant("addon.mod_wiki.editingpage",{$a:f}):this.translate.instant("addon.mod_wiki.newpagehdr"),this.blockId=this.wikiSync.getSubwikiBlockId(this.subwikiId,this.wikiId,this.userId,this.groupId),this.contentControl=i.control(""),this.pageForm=i.group({title:f}),this.pageForm.addControl("text",this.contentControl),this.syncProvider.blockOperation(this.component,this.blockId)}return n.prototype.ngOnInit=function(){var n=this;this.fetchWikiPageData().then(function(i){if(i&&n.blockId&&!n.isDestroyed){var t=n.wikiSync.getSubwikiBlockId(n.subwikiId,n.wikiId,n.userId,n.groupId);t!=n.blockId&&(n.syncProvider.unblockOperation(n.component,n.blockId),n.blockId=t,n.syncProvider.blockOperation(n.component,n.blockId))}}).finally(function(){n.loaded=!0})},n.prototype.fetchWikiPageData=function(){var n,i=this,t=!1;if(this.pageId)this.canEditTitle=!1,this.editing=!0,this.editOffline=!1,n=this.wikiProvider.getPageContents(this.pageId).then(function(n){return i.pageForm.controls.title.setValue(n.title),i.wikiId=n.wikiid,i.subwikiId=n.subwikiid,i.title=i.translate.instant("addon.mod_wiki.editingpage",{$a:n.title}),i.groupId=n.groupid,i.userId=n.userid,t=n.caneditpage,i.wikiSync.waitForSync(i.blockId)}).then(function(){return i.domUtils.isRichTextEditorEnabled()}).then(function(n){if(i.rteEnabled=n,n)return i.wikiProvider.getSubwikiFiles(i.wikiId,i.groupId,i.userId)}).then(function(n){return i.subwikiFiles=n,i.wikiProvider.getPageForEditing(i.pageId,i.section)}).then(function(n){var e=i.rteEnabled?i.textUtils.replacePluginfileUrls(n.content,i.subwikiFiles):n.content;i.contentControl.setValue(e),i.originalContent=e,i.version=n.version,t&&(i.renewLockInterval=setInterval(function(){i.renewLock()},k.a.RENEW_LOCK_TIME))});else{var e=this.pageForm.controls.title.value;n=this.wikiSync.waitForSync(this.blockId),e?n=n.then(function(n){if(n){var t=n.created.find(function(n){return n.title==e});if(t&&t.pageId>0)return i.pageId=t.pageId,i.fetchWikiPageData()}return i.wikiOffline.getNewPage(e,i.subwikiId,i.wikiId,i.userId,i.groupId)}).then(function(n){i.contentControl.setValue(n.cachedcontent),i.originalContent=n.cachedcontent,i.editOffline=!0}).catch(function(){i.editOffline=!1}):this.editOffline=!1,n.then(function(){i.editing=!1,t=!!i.blockId})}return n.then(function(){return!0}).catch(function(n){return i.domUtils.showErrorModalDefault(n,"Error getting wiki data."),i.forceLeavePage(),!1}).finally(function(){t||(i.domUtils.showAlert(i.translate.instant("core.notice"),i.translate.instant("addon.mod_wiki.cannoteditpage")),i.forceLeavePage())})},n.prototype.forceLeavePage=function(){this.forceLeave=!0,this.navCtrl.pop()},n.prototype.goToNewOfflinePage=function(n){this.courseId&&(this.module.id||this.wikiId)?this.editOffline&&!this.previousViewPageIsDifferentOffline(n)||(this.pageParamsToLoad={module:this.module,courseId:this.courseId,pageId:null,pageTitle:n,wikiId:this.wikiId,subwikiId:this.subwikiId,userId:this.userId,groupId:this.groupId}):this.domUtils.showAlert(this.translate.instant("core.success"),this.translate.instant("core.datastoredoffline")),this.forceLeavePage()},n.prototype.gotoPage=function(n){var i=this;return this.retrieveModuleInfo(this.wikiId).then(function(){var t=!1;i.initialSubwikiId&&(!i.editing&&i.editOffline&&i.previousViewPageIsDifferentOffline(n)?t=!0:!i.editOffline&&i.previousViewIsDifferentPageOnline()&&(t=!0)),t&&(i.pageParamsToLoad={module:i.module,courseId:i.courseId,pageId:i.pageId,pageTitle:n,wikiId:i.wikiId,subwikiId:i.subwikiId,userId:i.userId,groupId:i.groupId}),i.forceLeavePage()}).catch(function(){i.forceLeavePage()})},n.prototype.hasDataChanged=function(){var n=this.pageForm.value;return!(this.originalContent==n.text||!this.editing&&!n.text&&!n.title)},n.prototype.ionViewCanLeave=function(){return!!this.forceLeave||(!this.hasDataChanged()||this.domUtils.showConfirm(this.translate.instant("core.confirmcanceledit")))},n.prototype.ionViewDidLeave=function(){this.pageParamsToLoad&&this.navCtrl.push("AddonModWikiIndexPage",this.pageParamsToLoad)},n.prototype.previousViewIsDifferentPageOnline=function(){var n=this.navCtrl.getPrevious();return!this.editing||"AddonModWikiIndexPage"!=n.component.name||n.data.module.id!=this.module.id||n.data.pageId!=this.pageId},n.prototype.previousViewPageIsDifferentOffline=function(n){var i=this.navCtrl.getPrevious();if("AddonModWikiIndexPage"!=i.component.name||i.data.module.id!=this.module.id||i.data.wikiId!=this.wikiId||i.data.pageTitle!=n)return!0;var t=parseInt(i.data.subwikiId,10)||0;if(t>0&&this.subwikiId>0)return t!=this.subwikiId;var e=parseInt(i.data.userId,10)||0,l=parseInt(i.data.groupId,10)||0;return this.userId!=e||this.groupId!=l},n.prototype.save=function(){var n,i=this,t=this.pageForm.value,e=t.title,l=this.domUtils.showModalLoading("core.sending",!0),a=t.text;if(a=this.rteEnabled?this.textUtils.restorePluginfileUrls(a,this.subwikiFiles):this.textUtils.formatHtmlLines(a),this.editing)n=this.wikiProvider.editPage(this.pageId,a,this.section).then(function(){return i.wikiProvider.invalidatePage(i.pageId).then(function(){return i.gotoPage(e)})});else{if(!e)return this.domUtils.showAlert(this.translate.instant("core.notice"),this.translate.instant("addon.mod_wiki.titleshouldnotbeempty")),void l.dismiss();n=(n=this.editOffline?Promise.resolve():this.wikiOffline.getNewPage(e,this.subwikiId,this.wikiId,this.userId,this.groupId).then(function(){return Promise.reject(i.translate.instant("addon.mod_wiki.pageexists"))},function(){})).then(function(){var n=i.wikiId||i.module&&i.module.instance;return i.wikiProvider.newPage(e,a,i.subwikiId,n,i.userId,i.groupId).then(function(t){if(t>0)return i.pageId=t,i.wikiProvider.getPageContents(i.pageId).then(function(t){var l=[];return n=parseInt(t.wikiid,10),i.subwikiId||l.push(i.wikiProvider.invalidateSubwikis(n)),i.subwikiId=parseInt(t.subwikiid,10),i.userId=parseInt(t.userid,10),i.groupId=parseInt(t.groupid,10),l.push(i.wikiProvider.invalidateSubwikiPages(n)),Promise.all(l).then(function(){return i.gotoPage(e)})}).finally(function(){i.eventsProvider.trigger(k.a.PAGE_CREATED_EVENT,{pageId:i.pageId,subwikiId:i.subwikiId,pageTitle:e,siteId:i.sitesProvider.getCurrentSiteId()})});i.goToNewOfflinePage(e)})})}return n.catch(function(n){i.domUtils.showErrorModalDefault(n,"Error saving wiki data.")}).finally(function(){l.dismiss()})},n.prototype.renewLock=function(){var n=this;this.wikiProvider.getPageForEditing(this.pageId,this.section,!0).then(function(i){i.version&&n.version!=i.version&&(n.wrongVersionLock=!0)})},n.prototype.retrieveModuleInfo=function(n){var i=this;if(this.module.id&&this.courseId)return Promise.resolve();return(this.module.id?Promise.resolve(this.module):this.courseProvider.getModuleBasicInfoByInstance(n,"wiki")).then(function(t){if(i.module=t,i.componentId=i.module.id,!i.courseId&&i.module.course)i.courseId=i.module.course;else if(!i.courseId)return i.courseHelper.getModuleCourseIdByInstance(n,"wiki").then(function(n){i.courseId=n})})},n.prototype.ngOnDestroy=function(){this.isDestroyed=!0,clearInterval(this.renewLockInterval),this.blockId&&this.syncProvider.unblockOperation(this.component,this.blockId)},n}(),b=function(){return function(){}}(),P=t(925),C=t(926),y=t(927),O=t(928),L=t(929),E=t(930),x=t(931),T=t(932),D=t(933),U=t(936),M=t(937),F=t(938),S=t(34),V=t(20),A=t(19),N=t(4),W=t(30),B=t(32),R=t(95),j=t(78),H=t(14),J=t(28),Y=t(25),$=t(26),G=t(29),K=t(17),Z=t(225),q=t(391),z=t(35),Q=t(934),X=t(179),nn=t(21),tn=t(935),en=t(308),ln=t(223),an=t(41),on=t(5),un=t(24),rn=t(3),sn=t(16),dn=t(13),cn=t(23),gn=t(392),hn=t(44),fn=t(39),_n=t(180),In=t(94),pn=t(59),kn=t(57),wn=t(9),mn=t(255),vn=t(207),bn=t(155),Pn=t(55),Cn=o._1({encapsulation:2,styles:[],data:{}}),yn=o.Z("page-addon-mod-wiki-edit",v,function(n){return o._27(0,[(n()(),o._3(0,0,null,null,1,"page-addon-mod-wiki-edit",[],null,null,null,a,Cn)),o._2(1,245760,null,0,v,[Pn.a,d.d,nn.a,g.a,h.a,f.a,K.a,I.a,c.a,k.a,w.a,m.a,_.a,p.a],null,null)],function(n,i){n(i,1,0)},null)},{},{},[]),On=t(304),Ln=t(305),En=t(307),xn=t(306),Tn=t(390),Dn=t(528),Un=t(119),Mn=t(224);t.d(i,"AddonModWikiEditPageModuleNgFactory",function(){return Fn});var Fn=o._0(b,[],function(n){return o._11([o._12(512,o.j,o.W,[[8,[P.a,C.a,y.a,O.a,L.a,E.a,x.a,T.a,D.a,U.a,M.a,F.a,yn]],[3,o.j],o.v]),o._12(4608,wn.m,wn.l,[o.t,[2,wn.v]]),o._12(4608,d.x,d.x,[]),o._12(4608,d.d,d.d,[]),o._12(4608,On.b,On.a,[]),o._12(4608,Ln.a,Ln.b,[]),o._12(4608,En.b,En.a,[]),o._12(4608,xn.b,xn.a,[]),o._12(4608,K.a,K.a,[Tn.a,On.b,Ln.a,En.b,xn.b,K.b,K.c]),o._12(512,wn.b,wn.b,[]),o._12(512,d.v,d.v,[]),o._12(512,d.i,d.i,[]),o._12(512,d.s,d.s,[]),o._12(512,Dn.a,Dn.a,[]),o._12(512,u.a,u.a,[]),o._12(512,s.a,s.a,[]),o._12(512,Un.a,Un.a,[]),o._12(512,r.a,r.a,[]),o._12(512,Dn.b,Dn.b,[]),o._12(512,b,b,[]),o._12(256,K.c,void 0,[]),o._12(256,K.b,void 0,[]),o._12(256,Mn.a,v,[])])})}});